<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CARROT</title>
  <meta name="theme-color" content="#F6F2EA" />

  <!-- (중요) 캐시 무력화 힌트 -->
  <meta http-equiv="cache-control" content="no-store, no-cache, must-revalidate" />
  <meta http-equiv="pragma" content="no-cache" />
  <meta http-equiv="expires" content="0" />

  <!-- ✅ 자동 캐시 버스터: NFC로 열릴 때 '딱 1번' 자동 새로고침 -->
  <script>
    (function () {
      function bust() {
        const u = new URL(location.href);
        u.searchParams.set("t", Date.now().toString());
        location.replace(u.toString());
      }

      const u = new URL(location.href);

      // t가 없으면: 최초 진입이므로 1번만 강제 새로고침
      if (!u.searchParams.get("t")) {
        bust();
        return;
      }

      // iOS 사파리에서 이전 상태로 복원되는(bfcache) 경우 새로고침
      window.addEventListener("pageshow", (e) => {
        if (e.persisted) bust();
      });
    })();
  </script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&display=swap" rel="stylesheet">
  <link rel="stylesheet" as="style" crossorigin
    href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable.css" />

  <style>
    :root{
      --bg:#F6F2EA;
      --fg:#121212;
      --line: rgba(18,18,18,.12);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background: var(--bg);
      color: var(--fg);
      padding: 24px 16px;
      font-family: "Pretendard Variable", system-ui, -apple-system, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
    }
    .wrap{
      width:min(520px, 96vw);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap: 18px;
    }

    /* Screen 1 */
    .carrotScreen{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
    }
    .carrotBtn{
      border:none;
      background: transparent;
      padding:0;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      user-select:none;
      transform: translateY(0);
      transition: transform .08s ease;
    }
    .carrotBtn:active{ transform: translateY(2px); }
    .carrotImg{
      width: min(320px, 82vw);
      height: auto;
      display:block;
      filter: drop-shadow(0 18px 22px rgba(0,0,0,.12));
    }

    /* Screen 2 */
    .msgScreen{
      display:none;
      width:100%;
      flex-direction:column;
      align-items:center;
      gap: 12px;
      animation: fadeUp .18s ease-out forwards;
    }
    @keyframes fadeUp{
      from{ opacity:0; transform: translateY(8px); }
      to{ opacity:1; transform: translateY(0); }
    }

    .msg{
      width:100%;
      text-align:center;
      font-family: "Black Han Sans", system-ui, sans-serif;
      font-size: 28px;
      line-height: 1.25;
      letter-spacing: -.02em;
      min-height: 112px;
      padding: 0 10px;
    }

    .btn{
      width: 180px;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.65);
      box-shadow: 0 12px 26px rgba(0,0,0,.08);
      font-family: "Pretendard Variable", system-ui, sans-serif;
      font-weight: 650;
      font-size: 13px;
      cursor: pointer;
      transition: transform .08s ease;
    }
    .btn:active{ transform: translateY(1px); }

    .pop{ animation: pop .12s ease-out; }
    @keyframes pop{
      from{ transform: scale(.99); opacity:.6; }
      to{ transform: scale(1); opacity:1; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- SCREEN 1 -->
    <div class="carrotScreen" id="carrotScreen">
      <button class="carrotBtn" id="carrotBtn" aria-label="당근">
        <img class="carrotImg" id="carrotImg" src="" alt="carrot" />
      </button>
    </div>

    <!-- SCREEN 2 -->
    <div class="msgScreen" id="msgScreen">
      <div class="msg" id="msg"></div>
      <button class="btn" id="againBtn" type="button">한입 더</button>
    </div>
  </div>

  <script>
    /***********************
     * ✅ 여기만 바꾸면 됨 (A 방식: 파일명 버전업)
     ***********************/
    const IMG_FILE  = "carrot_v1.png";  // 예: carrot_v2.png
    const SND_FILE  = "bite_v1.mp3";  // 예: carrot_v2.mp3

    // 메시지(당근은 채찍보다 좀 “보상/칭찬” 톤 추천)
    const MESSAGES = [
      "잘했어. 지금 페이스 유지하면 돼.",
      "오늘의 너, 꽤 멋진데?",
      "한 걸음 했으면 이미 이긴 거야.",
      "조금씩 쌓이면 어느 순간 확 바뀐다.",
      "지금 이 10분이 내일을 살려.",
      "완벽 말고 꾸준함. 그게 진짜다.",
      "오늘 한 거, 너 스스로가 제일 알아.",
      "좋아. 이제 한 번 더 가자.",
      "멈추지 마. 너 이미 시작했어.",
      "지금 같은 리듬이 성장이다."
    ];

    const carrotScreen = document.getElementById("carrotScreen");
    const msgScreen = document.getElementById("msgScreen");
    const carrotBtn = document.getElementById("carrotBtn");
    const againBtn = document.getElementById("againBtn");
    const msgEl = document.getElementById("msg");
    const carrotImg = document.getElementById("carrotImg");

    function randMsg(){
      return MESSAGES[Math.floor(Math.random() * MESSAGES.length)];
    }

    // ✅ t 파라미터를 에셋에도 붙여서 캐시 완전 무력화
    const t = new URLSearchParams(location.search).get("t") || "0";

    // 경로: carrot/index.html 기준으로 assets 폴더가 바로 아래에 있어야 함
    carrotImg.src = `assets/${IMG_FILE}?t=${t}`;

    // 오디오 준비
    const carrotSound = new Audio(`assets/${SND_FILE}?t=${t}`);
    carrotSound.preload = "auto";
    carrotSound.volume = 1.0;
    try { carrotSound.load(); } catch(e) {}

    async function playSound(){
      try { carrotSound.pause(); carrotSound.currentTime = 0; } catch(e) {}
      // iOS: 클릭(사용자 제스처) 안에서 play()되어야 함
      try { await carrotSound.play(); } catch(e) {}
    }

    async function biteCarrot(){
      if (navigator.vibrate) navigator.vibrate([10, 20, 10]);

      await playSound();

      msgEl.classList.remove("pop");
      void msgEl.offsetWidth;
      msgEl.textContent = randMsg();
      msgEl.classList.add("pop");

      carrotScreen.style.display = "none";
      msgScreen.style.display = "flex";
    }

    function backToStart(){
      msgScreen.style.display = "none";
      carrotScreen.style.display = "flex";
      msgEl.textContent = "";
    }

    carrotBtn.addEventListener("click", biteCarrot);
    againBtn.addEventListener("click", backToStart);
    msgEl.textContent = "";
  </script>
</body>
</html>